# Regex from https://github.com/networktocode/ntc-templates/blob/master/templates/cisco_ios_show_access-list.template
---
- name: PARSER META DATA
  parser_metadata:
    version: 1.0
    command: show  ip access-list standard <>
    network_os: ios

- name: match sections
  pattern_match:
    # regex: id / permit or deny / IP / , |'wildcard bits' / wildcard mask /
    #     10 permit 10.244.62.129
    #    20 permit 192.168.87.0, wildcard bits 0.0.0.7
    regex: "(\\d*) (\\w+) (host\\s\\d+\\.\\d+\\.\\d+\\.\\d+|any|\\d+\\.\\d+\\.\\d+\\.\\d+\\s\\d+\\.\\d+\\.\\d+\\.\\d+|\\d+\\.\\d+\\.\\d+\\.\\d+,\\s+wildcard bits\\s\\d+\\.\\d+\\.\\d+\\.\\d+|\\d+\\.\\d+\\.\\d+\\.\\d+)"
    match_all: yes
  register: section
  export: yes

- name: GENERATE JSON DATA STRUCTURE
  json_template:
    template:
      - key: "{{ item.matches.0 }}"
        object:
          - key: action
            value: "{{ item.matches.1 }}"
          - key: source
            value: "{{ item.matches.2 | regex_replace(', wildcard bits','')}}"
          - key: rule
            value: "{{ item.matches.1 }} {{ item.matches.2 | regex_replace(', wildcard bits','')}}"
  loop: "{{ section }}"
  export: yes
  export_as: dict
  register: parsed_acl
