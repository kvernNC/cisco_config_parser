# Regex from https://github.com/networktocode/ntc-templates/blob/master/templates/cisco_ios_show_access-list.template
#    regex: "^.*?(?=\\nCommunity name:)"
---
- name: PARSER META DATA
  parser_metadata:
    version: 1.0
    command: show snmp community
    network_os: ios

- name: match sections
  pattern_match:
    regex: "^.*?(?=\\\nCommunity name:)"
    match_all: yes
    match_greedy: yes
  register: section

- name: match community
  pattern_group:
    - name: match name
      pattern_match:
        regex: "Community name: (\\w+)"
        content: "{{ item }}"
      register: name

    - name: match index
      pattern_match:
        regex: "Community Index: (\\w+)"
        content: "{{ item }}"
      register: index

    - name: match Security name
      pattern_match:
        regex: "Community SecurityName: (\\w+)"
        content: "{{ item }}"
      register: SecurityName

    - name: match description
      pattern_match:
        regex: "storage-type: (\\w+)"
        content: "{{ item }}"
      register: storagetype

    - name: match description
      pattern_match:
        regex: "access-list: (\\S+)"
        content: "{{ item }}"
      register: accesslist
  loop: "{{ section }}"
  register: communities


- name: GENERATE JSON DATA STRUCTURE
  json_template:
    template:
      - key: "{{ item.name.matches.0 }}"
        object:
          - key: index
            value: "{{ item.index.matches.0 }}"
          - key: securityName
            value: "{{ item.SecurityName.matches.0 }}"
          - key: storagetype
            value: "{{ item.storagetype.matches.0 }}"
          - key: accesslist
            value: "{{ item.accesslist.matches.0 }}"

  loop: "{{ communities }}"
  export: yes
  export_as: dict
  register: parsed_snmp_community
